<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Manage Session</title>
    <link href="bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="content/style.css" rel="stylesheet">
</head>

<body>
    <div class="container">
        <!-- Main Row encapsulates whole interface -->
        <div class="row inline-headers">
            <h2>Buzzer control</h2>
            <h2 class="pull-right">
                <a class="btn btn-info" href="/Share" target="share">Share Screen</a>
                <button id="email-session-url" class="btn btn-sm btn-primary"><span class="glyphicon glyphicon-envelope"></span> Email session link</button>
            </h2>
        </div>
        <!-- Buttons row -->
        <div class="row">
            <div class="col-sm-4">
                <div class="row row-buffer">
                    <div class="col-xs-12">
                        <button id="btn-session-enable" type="button" class="btn btn-lg btn-primary" disabled>Enable buzzer</button>
                        <button id="btn-session-disable" type="button" class="btn btn-lg btn-default">Disable buzzer</button>
                    </div>
                </div>
            </div>
            <div class="col-sm-4">
                <div class="row row-buffer">
                    <div class="col-xs-12">
                        <button id="btn-session-accept" type="button" class="btn btn-lg btn-success" disabled><span class="glyphicon glyphicon-thumbs-up"></span> Correct</button>
                        <button id="btn-session-reject" type="button" class="btn btn-lg btn-warning" disabled><span class="glyphicon glyphicon-thumbs-down"></span> Incorrect</button>
                    </div>
                </div>
            </div>
            <div class="col-sm-4">
                <div class="row row-buffer">
                    <div class="col-xs-12">
                        <button id="btn-session-reset" type="button" class="btn btn-lg btn-default hidden"><span class="glyphicon glyphicon-refresh"></span> Reset</button>
                        <button id="btn-session-complete" type="button" class="btn btn-lg btn-danger"><span class="glyphicon glyphicon-remove-circle"></span> End Session</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- Settings row -->
        <div class="row row-buffer">
            <div class="col-xs-4 col-sm-2 text-right">
                <h2>Settings</h2>
            </div>
            <div class="col-xs-8 col-sm-10">
                <button id="button-edit-settings" type="button" style="margin-top:20px;" class="btn btn-default"><span class="glyphicon glyphicon-cog"></span> Edit</button>
            </div>
        </div>
        <!-- Info row -->
        <div class="row row-buffer h5">
            <!-- Left column - This holds main data -->
            <div class="col-sm-6">
                <div class="row row-buffer">
                    <div class="col-xs-5 text-right">
                        Session Name:
                    </div>
                    <div id="session-name" class="col-xs-7">

                    </div>
                </div>
                <div class="row row-buffer">
                    <div class="col-xs-5 text-right">
                        Teams:
                    </div>
                    <div id="session-teams" class="col-xs-7">

                    </div>
                </div>
                <div class="row row-buffer hide-if-teams">
                    <div class="col-xs-5 text-right">
                        Max players:
                    </div>
                    <div id="session-max-players" class="col-xs-7">

                    </div>
                </div>

            </div>
            <div class="col-sm-6 hide-if-not-teams">
                <div class="row row-buffer">
                    <div class="col-xs-5 text-right">
                        Max teams:
                    </div>
                    <div id="session-max-teams" class="col-xs-7">

                    </div>
                </div>
                <div class="row row-buffer">
                    <div class="col-xs-5 text-right">
                        Max players per teams:
                    </div>
                    <div id="session-max-team-players" class="col-xs-7">

                    </div>
                </div>
                <div class="row row-buffer">
                    <div class="col-xs-5 text-right">
                        Team selection mode:
                    </div>
                    <div id="session-team-selection" class="col-xs-7">

                    </div>
                </div>
                <div class="row row-buffer">
                    <div class="col-xs-5 text-right">
                        Team leader selection:
                    </div>
                    <div id="session-leader-selection" class="col-xs-7">

                    </div>
                </div>
                <div class="row row-buffer">
                    <div class="col-xs-5 text-right">
                        Team name editing:
                    </div>
                    <div id="session-team-name-edit" class="col-xs-7">

                    </div>
                </div>
            </div>
        </div>
        <hr>
        <!-- Session stats -->
        <div class="row">
            <div class="col-sm-6">
                <div class="row">
                    <div class="col-xs-12">
                        <h4 id="round-winner-header">Round winner</h4>
                        <div id="round-winner" class="well"></div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-xs-12">
                        <h4>Previous winners</h4>
                        <div id="previous-winners" class="well no-bullets-all">
                            <ul class="list-group"></ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-sm-6">
                <h4 id="participant-info-header">Participants</h4>
                <div id="participant-info" class="well well-lg no-bullets-all">
                    <ul class="top-header list-group">
                    </ul>
                </div>
            </div>
        </div>

        <!--Settings Modals, modal-settings-teams -->
        <div class="modal fade" id="modal-settings-teams">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                        <h4 class="modal-title">Settings</h4>
                    </div>
                    <form class="form" id="form-change-settings-teams">
                        <div class="modal-body">
                            <div class="form-group row">
                                <label class="col-sm-3 col-form-label" for="session-name-edit-teams">Session Name</label>
                                <div class="col-sm-9">
                                    <input class="form-control" type="text" id="session-name-edit-teams" name="session-name-edit-teams" />
                                </div>
                            </div>
                            <div id="options-teams">
                                <div class="form-group row">
                                    <label class="col-sm-3 col-form-label" for="num-teams">Teams</label>
                                    <div class="col-sm-9">
                                        <input class="form-control" type="number" id="num-teams" placeholder="3" name="num-teams" />
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <label class="col-sm-3 col-form-label" for="max-players-teams">Max players per team</label>
                                    <div class="col-sm-9">
                                        <input class="form-control" type="number" id="max-players-teams" placeholder="3" name="max-players-teams" />
                                    </div>
                                </div>
                                <div id="options-manual-name-selection">
                                </div>
                                <div id="team-leader-table">
                                    <table class="table table-responsive table-hover table-striped">
                                        <thead>
                                            <tr>
                                                <th>Team</th>
                                                <th data-toggle="tooltip" title="Selected contestant is leader">Team leader</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- Each of these will be generated -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary">Update</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <!-- Settings Modals, modal-settings -->
        <div class="modal fade" id="modal-settings">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                        <h4 class="modal-title">Settings</h4>
                    </div>
                    <form class="form" id="form-change-settings">
                        <div class="modal-body">
                            <div class="form-group row">
                                <label class="col-sm-3 col-form-label" for="session-name-edit">Session Name</label>
                                <div class="col-sm-9">
                                    <input class="form-control" type="text" id="session-name-edit" name="session-name-edit" />
                                </div>
                            </div>

                            <div id="options-max-players" class="form-group row">
                                <label class="col-sm-3 col-form-label" for="max-players">Max Players</label>
                                <div class="col-sm-9">
                                    <input class="form-control" type="number" id="max-players" placeholder="25" name="max-players" />
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary">Update</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Session complete confirmation modal, modal-confirm-complete-->
        <div class="modal fade" id="modal-confirm-complete">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                        <h4 class="modal-title">End Session?</h4>
                    </div>
                    <div class="modal-body">
                        Are you sure you want to end the session?
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">No</button>
                        <button id="btn-confirm-complete" type="button" class="btn btn-primary">Yes</button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script src="http://code.jquery.com/jquery-latest.min.js"></script>
    <script src="bootstrap/js/bootstrap.min.js"></script>
    <script src="js/bundle.js"></script>
    <script src="js/controller.js"></script>
    <script>
        var sessionInfo = null;
        var sessionCookie;
        var participantCookie;
        var handleSessionInformationRequest = function(values){
            sessionInfo = values.data._info;
            console.log(sessionInfo);
        }
        var handleUpdateSettingsError = function(er){
            if($('#modal-settings').is(':visible')){
                alertBootstrap(er.error,'danger',true,'#modal-settings .modal-body');
            }
            if($('#modal-settings-teams').is(':visible')){
                alertBootstrap(er.error,'danger',true,'#modal-settings-teams .modal-body');
            }
        }
        var handleUpdateSettingsSuccess = function(){
            if($('#modal-settings').is(':visible')){
                $('#modal-settings').modal('hide');
            }
            if($('#modal-settings-teams').is(':visible')){
                $('#modal-settings-teams').modal('hide');
            }
        }
        
        var updateShareView = function(values){
            sessionInformationRequest(values.sessionId,values.participantId);
            //clear alerts
            $('#error-alert').remove();

            if(values.gameState.currentState === 'pending'){
                $('#btn-session-disable').prop('disabled',true);
                $('#btn-session-accept').prop('disabled',false);
                $('#btn-session-reject').prop('disabled',false);
                if(values.gameState.pendingWinner){
					$('#round-winner-header').text("Buzzed in");
					$('#round-winner').addClass("bg-success");
					$('#round-winner').text(values.gameState.pendingWinner);
				}
			}else if(values.gameState.currentState === 'ready'){
				$('#btn-session-enable').prop('disabled',true);
                $('#btn-session-disable').prop('disabled',false);
                $('#btn-session-accept').prop('disabled',true);
                $('#btn-session-reject').prop('disabled',true);
			}else if(values.gameState.currentState === 'buzzerLock'){
				$('#btn-session-enable').prop('disabled',false);
                $('#btn-session-disable').prop('disabled',true);
			}


            $('#session-name').text(values.gameState.settings.sessionName);
			if(values.gameState.settings.hasTeams){
				$('#session-teams').text('Yes');
                
                //Hide non-team info
                $('.hide-if-teams').hide();

                $('#participant-info-header').text('Teams');
                $('#session-max-teams').text((values.gameState.settings.maxTeams === 999) ? 'Unlimited' : values.gameState.settings.maxTeams);
                $('#session-max-team-players').text((values.gameState.settings.teamSize === 999) ? 'Unlimited' : values.gameState.settings.teamSize);
                $('#session-leader-selection').text(Object.keys(buzzapi.constants.teamLeaderSelectionMethod)[values.gameState.settings.teamLeaderSelectionMethod]);
                $('#session-team-name-edit').text(Object.keys(buzzapi.constants.teamNameEdit)[values.gameState.settings.teamNameEdit]);
                $('#session-team-selection').text(Object.keys(buzzapi.constants.teamSelectionMethod)[values.gameState.settings.teamSelectionMethod]);
				$('#participant-info > ul').empty();
				$.each(values.gameState.teams, function(key,item){
					$('#participant-info > ul').append('<li class="list-group-item" id="team-li-'+key+'">'+item.teamName+'<span class="total-team-score badge badge-primary pull-right"></span><ul class="list-group"></ul></li>');
					var listKey = key;
					var totalScore = 0;
					$.each(item.contestants, function(key,contestant){
						if(contestant.disconnected){
							$('#team-li-'+listKey + ' > ul').append('<li class="list-group-item"><i>'+contestant.username+' </i><span class="badge pull-right">'+contestant.score+'</span></li>');
						
						}else{
							$('#team-li-'+listKey + ' > ul').append('<li class="list-group-item">'+contestant.username+' <span class="badge pull-right">'+contestant.score+'</span></li>');
						}
                        totalScore += contestant.score;
					});
					
					$('#team-li-'+listKey + ' > .total-team-score').text(totalScore);
				});
			}else{ //non-teams game so list all players
                $('#session-teams').text('No');
                $('#session-max-players').text((values.gameState.settings.maxContestants === 999) ? 'Unlimited' : values.gameState.settings.maxContestants);

                //Hide the teams
                $('.hide-if-not-teams').hide();

				$('#participant-info > ul').empty();
				$.each(values.gameState.contestants, function(key,item){
                    if(item.disconnected){
						$('#participant-info > ul').append('<li class="list-group-item"><i>'+item.username+'</i><span class="badge pull-right">'+item.score+'</span></li>');
				
					}else{
						$('#participant-info > ul').append('<li class="list-group-item">'+item.username+' <span class="badge pull-right">'+item.score+'</span></li>');
					}
				});
			}
			if(values.gameState.roundWinner && values.gameState.currentState !== 'pending'){
				$('#round-winner-header').text("Round winner");
				$('#round-winner').removeClass("bg-success");
				$('#round-winner').text(values.gameState.roundWinner);
			}else if(values.gameState.roundWinner === null && values.gameState.currentState !== 'pending'){
                $('#round-winner-header').text("Round winner");
				$('#round-winner').removeClass("bg-success");
                $('#round-winner').text('');
            }

			$('#previous-winners > ul').empty();
			$.each(values.gameState.previousWinners,function(key,item){
				$('#previous-winners > ul').prepend('<li class="list-group-item">'+item+'</li>');
			});

            gameSettings = values.gameState.settings;
			
        }
		$(function(){ //UI Modal code
			var teamNames = [];

			/**$("#num-teams").on('keyup mouseup',function(){
				
				var loops = parseInt($('#num-teams').val());
				if(loops == ""){return;}
				if(loops > teamNames.length)
				{
					for(i=teamNames.length; i < loops;i++)
					{
						var label = i+1;
						var x = teamNames.push('<div id="team-name-div-'+label+'" class="form-group row">'+
								'<label class="col-sm-3 col-form-label" for="team-name-'+label+'">Team '+label+'</label>'+
								'<div class="col-sm-9">'+
								'<input class="form-control" type="text" id="team-name-'+label+'" name="team-name-'+label+'" /></div></div>');
						$('#options-manual-name-selection').append(teamNames[x-1]);
					}
				}
				else if(loops < teamNames.length)
				{
					for(i = loops; i <= teamNames.length;i++)
					{
						var label = i+1;
						$('#team-name-div-'+ label).remove();
						
					}
					teamNames.splice(loops,teamNames.length)
				}
				
			});
            */
			
			$('#btn-session-complete').click(function(){
                $('#modal-confirm-complete').modal();
            });

            $('#button-edit-settings').click(function(){
                if(sessionInfo.session.settings.hasTeams){
                    $('#session-name-edit-teams').val(sessionInfo.session.settings.sessionName);
                    $('#num-teams').prop('min',sessionInfo.session.settings.maxTeams);
                    $('#num-teams').prop('placeholder',sessionInfo.session.settings.maxTeams + ', you can only increase from this number.');
                    $('#max-players-teams').prop('min',sessionInfo.session.settings.teamSize);
                    $('#max-players-teams').prop('placeholder',sessionInfo.session.settings.teamSize + ', you can only increase from this number.');
                    

                    $('#team-leader-table tbody').empty();
                    $.each(sessionInfo.session.teams.teams,function(key,team){
                        var teamId = team.teamName.split(' ').join('-');
                        $('#team-leader-table tbody').append('<tr><td><input class="team-name-item '+teamId+'" id="session-edit-name-'+teamId+'" value="'+team.teamName+'" /></td>'+
                            '<td><select class="full-width team-leader-item" id="team-leader-'+teamId+'" name="'+teamId+'">'+
                             '</select></td></tr>');
                        $.each(team.contestants.participants,function(key,contestant){
                            var teamLeader = null;
                            try{
                                teamLeader = team.teamLeader.username;
                            }catch(exception){
                                teamLeader = '';
                            }
                            if(contestant.username === teamLeader){
                                $('#team-leader-'+teamId).append(
                                    '<option selected value="'+contestant.username+'">'+contestant.username+'</option>'
                                );
                            }else{
                                $('#team-leader-'+teamId).append(
                                    '<option value="'+contestant.username+'">'+contestant.username+'</option>'
                                );
                            }
                                        
                        });
                    });

                    $('#modal-settings-teams').modal();
                }else{
                    $('#session-name-edit').val(sessionInfo.session.settings.sessionName);
                    $('#max-players').prop('min',sessionInfo.session.settings.maxContestants);
                    $('#max-players').prop('placeholder',sessionInfo.session.settings.maxContestants + ', you can only increase from this number.');
                    $('#modal-settings').modal();
                }
            });

            $('#form-change-settings').submit(function(event){
                event.preventDefault();
                var values = [];
                var sessionName = $('#session-name-edit').val();
                var maxContestants = $('#max-players').val();
                if(sessionInfo.session.settings.sessionName !== sessionName){
                    values.sessionName = sessionName;
                }
                if(sessionInfo.session.settings.maxContestants < maxContestants){
                    values.maxContestants = parseInt(maxContestants);
                }
                hostUpdateSettings(sessionCookie,participantCookie,values);

            });

            $('#form-change-settings-teams').submit(function(event){
                event.preventDefault();
                var values = [];
                var sessionName = $('#session-name-edit-teams').val();
                if(sessionInfo.session.settings.sessionName !== sessionName){
                    values.sessionName = sessionName;
                }
                var teamSize = $('#max-players-teams').val();
                if(sessionInfo.session.settings.teamSize < teamSize){
                    values.teamSize = parseInt(teamSize);
                }
                var maxTeams = $('#num-teams').val()
                if(sessionInfo.session.settings.maxTeams < maxTeams){
                    values.maxTeams = parseInt(maxTeams);
                }

                $.each($('.team-name-item'),function(key){
                    var oldValue = $(this).prop('defaultValue');
                    var newValue = $(this).val();
                    if(newValue !== oldValue){
                        if(values.teamNameChange === undefined){
                            values.teamNameChange = [];
                        }
                        var nameChangeObject=[];
                        nameChangeObject.teamNameFrom = oldValue;
                        nameChangeObject.teamNameTo = newValue;
                        values.teamNameChange.push(nameChangeObject);
                    }
                });
                $.each($('.team-leader-item'),function(key){
                    
                    var newValue = $(this).val();
                    var id = $(this).prop('name');
                    
                    if(newValue !== null){
                    
                        if(values.teamLeaderChange === undefined){
                            values.teamLeaderChange = [];
                        }
                        var leaderChangeObject=[];
                        leaderChangeObject.teamName = $('input.'+id).val();
                        leaderChangeObject.teamLeaderUsername = newValue;
                        values.teamLeaderChange.push(leaderChangeObject);
                    }
                    
                });
                
                hostUpdateSettings(sessionCookie,participantCookie,values);
            });
		});

        $(function(){ //Messaging and socket updates
            handleDisconnect();
			
			sessionCookie = buzzapi.Cookie.get('sessionId');
            participantCookie = buzzapi.Cookie.get('hostId');
	
            if(sessionCookie != undefined && participantCookie != undefined){
                rejoinSession(sessionCookie,participantCookie,buzzapi.constants.rejoinAs.HOST);
            }
			else{
				alertBootstrap('No session data found, please join or create a session and try again','warning',true);
				$('.container > .row div:not(:first)').hide();
			}

            $('#btn-confirm-complete').click(function(){
                closeSession(sessionCookie,participantCookie)
                window.location.href = '/New';
            });

            $('#btn-session-accept').click(function(){
                buzzerManageCommand(sessionCookie,participantCookie,buzzapi.constants.buzzerActionCommands.ACCEPT);
            });
            $('#btn-session-reject').click(function(){
                buzzerManageCommand(sessionCookie,participantCookie,buzzapi.constants.buzzerActionCommands.REJECT);
            });
            $('#btn-session-enable').click(function(){
                buzzerManageCommand(sessionCookie,participantCookie,buzzapi.constants.buzzerActionCommands.ENABLE);
            });
            $('#btn-session-disable').click(function(){
                buzzerManageCommand(sessionCookie,participantCookie,buzzapi.constants.buzzerActionCommands.DISABLE);
            });
            $('#btn-session-reset').click(function(){
                buzzerManageCommand(sessionCookie,participantCookie,buzzapi.constants.buzzerActionCommands.RESET);
            });

            $('#email-session-url').click(function(){
				var url = generateWebUrl() + '/Join?sessionid='+sessionCookie;

				var sessionName = sessionInfo.session.settings.sessionName;
				window.location.href = 'mailto:?to=&body=Please follow the folowing link to join: '+sessionName+'%0A'+url+'&subject=Join Trivia Session';
				
			});
		});
		
	</script>

</body>

</html>